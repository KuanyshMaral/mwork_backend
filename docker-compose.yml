# Версия синтаксиса
version: '3.8'

# "Сервисы" (контейнеры), которые мы запускаем
services:

  # 1. Сервис Базы Данных (PostgreSQL)
  db:
    image: postgres:15-alpine
    container_name: mwork_db
    # Эти переменные создадут базу данных и пользователя при первом запуске
    # ЗАМЕНИ ИХ на те, что у тебя в .env файле
    environment:
      - POSTGRES_USER=myuser
      - POSTGRES_PASSWORD=mypassword
      - POSTGRES_DB=mydb_name
    ports:
      # Открываем порт 5432 наружу (на твоем ПК), чтобы ты мог подключиться к БД
      - "5432:5432"
    volumes:
      # Эта строка ОЧЕНЬ ВАЖНА: она сохраняет данные твоей БД
      # даже если ты перезапустишь контейнер
      - postgres_data:/var/lib/postgresql/data

  # 2. Сервис твоего приложения (Go)
  app:
    # "Собери этот сервис, используя Dockerfile в этой же папке (.)"
    build: .
    container_name: mwork_backend
    ports:
      # "Пробрось порт 8080 с моего ПК на порт 8080 в контейнере"
      # (поставь тут свой порт, как в Dockerfile)
      - "4000:4000"

    # Эта строка ОЧЕНЬ ВАЖНА: она берет твой .env файл
    # и "скармливает" его приложению внутри контейнера
    env_file:
      - .env

    # Эта строка ОЧЕНЬ ВАЖНА: она связывает папку 'uploads' на твоем ПК
    # с папкой '/app/uploads' внутри контейнера.
    # Так твои файлы не пропадут и будут видны из контейнера.
    volumes:
      - ./uploads:/app/uploads

    # Эта команда говорит: "Не запускай 'app', пока 'db' не будет готова"
    depends_on:
      - db

# "Тома" - это хранилища данных
volumes:
  # Здесь мы "объявляем" том, который использовали для 'db'
  postgres_data: