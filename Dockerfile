# --- ЭТАП 1: "СБОРЩИК" ---
# Берем официальный образ Go (версию можешь поменять на свою из go.mod)
FROM golang:1.21-alpine AS builder

# Устанавливаем рабочую папку внутри контейнера
WORKDIR /build

# Копируем сначала файлы зависимостей
COPY go.mod go.sum ./
# Скачиваем зависимости (этот шаг кэшируется, если go.mod не менялся)
RUN go mod download

# Копируем ВЕСЬ остальной код проекта
COPY . .

# Собираем наше приложение из cmd/web/main.go
# CGO_ENABLED=0 - важно для создания статичного бинарника, который не требует доп. библиотек
# -o /app/server - говорим собрать все в один файл /app/server
RUN CGO_ENABLED=0 go build -o /app/server ./cmd/web/main.go


# --- ЭТАП 2: "ФИНАЛЬНЫЙ" ---
# Берем самый маленький базовый образ
FROM alpine:latest

# Рабочая папка, где будет жить приложение
WORKDIR /app

# Копируем наш собранный бинарник из ЭТАПА 1 (из /app/server)
COPY --from=builder /app/server .

# Судя по структуре, твоему приложению нужны шаблоны и миграции.
# Копируем их тоже.
COPY templates ./templates
COPY database/migrations ./database/migrations

# Открываем порт, на котором работает твой сервер.
# Я не знаю, какой у тебя порт в .env, но обычно это 8000, 8080 или 3000.
# Поставь сюда свой порт. Я для примера поставлю 8080.
EXPOSE 4000

# Команда для запуска твоего приложения, когда контейнер стартует
CMD ["./server"]